name: ML CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'   # Global Python version for all jobs

jobs:
  # Stage 1: Setup & Lint
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r ./requirements.txt

    - name: Lint code (basic)
      run: python -m compileall ./src ./app

  # Stage 2: Unit Tests
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r ./requirements.txt

    - name: Run unit tests (dataset)
      run: python ./test/test_dataset.py

    - name: Run unit tests (artifacts)
      run: python ./test/test_artifacts.py

    # - name: Run unit tests (app api)
    #   run: python ./test/test_app_api.py

  # Stage 3: Train Model
  train:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r ./requirements.txt

    - name: Train model
      run: python ./scripts/model_training.py

    - name: Upload model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: ./artifacts/

  # Stage 4: Docker Build & API Test
  docker-test:
    runs-on: ubuntu-latest
    needs: train
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t heart-disease-api .

      - name: Run Docker container
        run: docker run -d -p 8000:8000 --name heart-api heart-disease-api

      - name: Wait for API to be ready
        run: |
          for i in {1..10}; do
            curl -s http://localhost:8000/ && break || sleep 2
          done

      - name: Test /predict endpoint
        run: |
          curl -X POST "http://localhost:8000/predict" \
            -H "Content-Type: application/json" \
            -d '{"age":63,"sex":1,"chest_pain":3,"resting_bp":145,"chol":233,"fasting_bs":1,"rest_ecg":0,"max_hr":150,"exercise_angina":0,"oldpeak":2.3,"st_slope":0,"Ca":0,"thal":1}'

      - name: Stop Docker container
        run: docker stop heart-api

      - name: Remove Docker container
        run: docker rm heart-api

  # Stage 5: Push Docker Image to AWS ECR
  push-to-ecr:
    runs-on: ubuntu-latest
    needs: train
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        run: docker build -t heart-disease-api .

      - name: Tag Docker image
        run: docker tag heart-disease-api:latest 112875909909.dkr.ecr.ap-south-1.amazonaws.com/heart-disease-api:latest

      - name: Push Docker image to ECR
        run: docker push 112875909909.dkr.ecr.ap-south-1.amazonaws.com/heart-disease-api:latest

  # Stage 6: Deploy to EKS
  deploy-to-eks:
    runs-on: ubuntu-latest
    needs: push-to-ecr
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Update kubeconfig for EKS
        run: aws eks update-kubeconfig --region ap-south-1 --name heart-disease-cluster

      - name: Deploy to EKS
        run: kubectl apply -f k8s/

  # Stage 7: Deploy with Helm
  helm-deploy:
    runs-on: ubuntu-latest
    needs: push-to-ecr
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Update kubeconfig for EKS
        run: aws eks update-kubeconfig --region ap-south-1 --name heart-disease-cluster

      - name: Deploy/Upgrade with Helm
        run: |
          helm upgrade --install heart-disease ./helm/heart-disease --namespace default --wait
